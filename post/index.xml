<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on A Cat Entertainer</title><link>https://blog.xiax.xyz/post/</link><description>Recent content in Posts on A Cat Entertainer</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 25 Mar 2024 06:23:23 -0700</lastBuildDate><atom:link href="https://blog.xiax.xyz/post/index.xml" rel="self" type="application/rss+xml"/><item><title>Mahjong Detection with Yolo (Draft, Work in Progress)</title><link>https://blog.xiax.xyz/p/mahjong-detection-with-yolo-draft-work-in-progress/</link><pubDate>Sat, 23 Mar 2024 14:01:37 +0000</pubDate><guid>https://blog.xiax.xyz/p/mahjong-detection-with-yolo-draft-work-in-progress/</guid><description>&lt;img src="https://blog.xiax.xyz/p/mahjong-detection-with-yolo-draft-work-in-progress/imgs/mahjong_hand.jpg" alt="Featured image of post Mahjong Detection with Yolo (Draft, Work in Progress)" />&lt;h1 id="mahjong-detection-with-yolo-models">Mahjong Detection with Yolo Models&lt;/h1>
&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>Recently I started an interesting endeavor to detect and recognize mahjong hands from a given image and calculate the score of the hand. This idea pops to me because in Riichi Mahjong, scoring is very difficult and requires a lot of familarity with the rules. Especially for beginners, it is very hard to calculate the score of a hand because one has to be really adequate with the concept of Fu and Han.&lt;/p>
&lt;p>The Han and Fu is different from hand to hand. Fu is particularly difficult to remember.
Therefore, I started to think what if I can just take a picture with my phone and the app can tell me the score of the hand. That would be very convenient especially for beginners.&lt;/p>
&lt;h2 id="my-deployed-model-to-try-out">My deployed model to try out&lt;/h2>
&lt;h2 id="other-interesting-mahjong-apps-i-deployed">Other interesting mahjong apps I deployed&lt;/h2>
&lt;h2 id="first-step-struggle-to-train-locally">First Step: Struggle to train locally&lt;/h2>
&lt;ol>
&lt;li>Found a random repo on github that geneartes mahjong tiles on random background.&lt;/li>
&lt;li>The quality of the images are not very good, and I trained Yolo v5 and v8 on it, the recognition result is rather terrible.&lt;/li>
&lt;li>Todo: talk about yolo v5 and v8&lt;/li>
&lt;li>Todo: talk about training on Apple silicon.&lt;/li>
&lt;/ol>
&lt;h2 id="second-step-roboflow-is-the-saver">Second Step: Roboflow is the Saver&lt;/h2>
&lt;ol>
&lt;li>Found really great training data on Roboflow with mahjong tiles.&lt;/li>
&lt;li>Training on local takes forever but now performs much better.&lt;/li>
&lt;/ol>
&lt;h2 id="third-step-training-on-roboflow">Third Step: Training on Roboflow&lt;/h2>
&lt;ol>
&lt;li>Thanks to Eli from Roboflow team who geneoursly provided me with 20 free training credits.&lt;/li>
&lt;li>Hitting mAP, Precision, Recall over 99% but performs terribly on my own mahjong&lt;/li>
&lt;/ol>
&lt;h2 id="fourth-step-training-on-my-own-mahjong">Fourth Step: Training on my own mahjong&lt;/h2>
&lt;ol>
&lt;li>Take pictures&lt;/li>
&lt;li>Found human lablellers for cheap on taobao. $0.01 per detection box.&lt;/li>
&lt;li>Training on Roboflow again&lt;/li>
&lt;li>Does it much better now.&lt;/li>
&lt;li>Add screenshots below&lt;/li>
&lt;/ol>
&lt;h2 id="step-5-stretch-goals">Step 5: Stretch Goals&lt;/h2>
&lt;ul>
&lt;li>Mahjong Scoring, talk about different scoring packages I found&lt;/li>
&lt;li>Add inference code demo&lt;/li>
&lt;li>How to calulate SHanten etc.&lt;/li>
&lt;/ul>
&lt;h2 id="appendix">Appendix&lt;/h2>
&lt;h3 id="code-samples">Code Samples&lt;/h3>
&lt;h4 id="inferenceclient">InferenceClient&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">inference_sdk&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">InferenceHTTPClient&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">InferenceConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#### Inference Engine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MahjongInference&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">api_key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">model_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">test_image_dir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">test_image_dir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">test_image_dir&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">api_key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">api_key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">model_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">model_id&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_extensions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;.jpg&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.jpeg&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.gif&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.bmp&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;.tiff&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">test_image_dir&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_files&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_image_files_from_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">test_image_dir&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CLIENT&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">InferenceHTTPClient&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api_url&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;https://detect.roboflow.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">api_key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">api_key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">custom_configuration&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">InferenceConfiguration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">confidence_threshold&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">0.5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">max_detections&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CLIENT&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">custom_configuration&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># self.result = None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">infer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CLIENT&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">infer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">model_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">model_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">infer_single_image&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">image_path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CLIENT&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">infer&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">image_path&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">model_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">model_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">infer_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">directory_path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">image_files&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_image_files_from_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">directory_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">CLIENT&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">infer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">model_id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">model_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get_image_files_from_directory&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">directory_path&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">files_in_directory&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">listdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">directory_path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">directory_path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">files_in_directory&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">splitext&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">lower&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_extensions&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="s2">&amp;#34;annotated&amp;#34;&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="hand-scorer">Hand Scorer&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mahjong.hand_calculating.hand&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HandCalculator&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mahjong.tile&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">TilesConverter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mahjong.hand_calculating.hand_config&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">HandConfig&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mahjong.meld&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Meld&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">collections&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">defaultdict&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">mahjong.shanten&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Shanten&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MahjongScorer&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">player_wind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;east&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">round_wind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;east&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">HandCalculator&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">HandConfig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_tsumo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">is_riichi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">player_wind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">player_wind&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">round_wind&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">round_wind&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dora_indicators&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">update_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">kwargs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">setattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">update_dora_indicators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dora_indicators&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dora_indicators&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dora_indicators&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_parse_hand_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_dict&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">tile&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="s1">&amp;#39;m&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;m&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="s1">&amp;#39;p&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;p&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="s1">&amp;#39;s&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;s&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="s1">&amp;#39;z&amp;#39;&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;z&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sorted_hand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">suit&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="s1">&amp;#39;mpsz&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">suit&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">hand_dict&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sorted_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&amp;#39;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand_dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">suit&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sorted_hand&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">sorted_tiles&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">suit&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">sorted_hand&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_convert_hand_to_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tiles_type&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand_string&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_parse_hand_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">tiles_type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">136&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">TilesConverter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">one_line_string_to_136_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">hand_string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">TilesConverter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">one_line_string_to_34_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">hand_string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_tile_string_representation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_parse_hand_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_calculate_dora_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">TilesConverter&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">one_line_string_to_136_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dora_indicators&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_print_verbose&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;你的手牌是: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_tile_string_representation&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;点数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cost&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;total&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 番数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 符数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fu&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 牌型: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 满吗: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cost&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;yaku_level&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">yaku&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="s2">役: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 役数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han_closed&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">fu_item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fu_details&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fu_item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Congrats!&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">hand_score&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">win_tile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_convert_hand_to_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tiles_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">136&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">parsed_win_tile&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_convert_hand_to_tiles&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">win_tile&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">tiles_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">136&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">dora_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_calculate_dora_tiles&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">estimate_hand_value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tiles&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">parsed_win_tile&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dora_indicators&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">dora_tiles&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_print_verbose&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cost&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;total&amp;#39;&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ERROR:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_shanten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_convert_hand_to_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tiles_type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">34&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">shanten_calculator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Shanten&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">shanten_calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_shanten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tiles&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">_generate_full_tile_set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">numbered_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">num&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">suit&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">suit&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="s2">&amp;#34;mps&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">num&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">honor_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">num&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">z&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">num&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="c1"># Only 1z through 7z exist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">numbered_tiles&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">honor_tiles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_tenpai_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">full_tile_set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_generate_full_tile_set&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">winning_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">tile&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">full_tile_set&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">score&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hand_score&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">win_tile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">score&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">winning_tiles&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">score&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">sorted&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">winning_tiles&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">reverse&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">print_possible_wins&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">winning_tiles&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">winning_tiles&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="s2">无役 别搞了!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">score&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">winning_tiles&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t\t&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="s1">&amp;#39;自摸&amp;#39;&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_tsumo&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="s1">&amp;#39;荣和&amp;#39;&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 点数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cost&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;total&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 番数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 符数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fu&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 牌型: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 满吗: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cost&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;yaku_level&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">yaku&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t\t\t&lt;/span>&lt;span class="s2">役: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">, 役数: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han_open&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han_open&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">yaku&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">han_closed&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">fu_item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fu_details&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t\t\t&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fu_item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">list_all_possible_wins&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;听牌! 你的手牌是: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_parse_hand_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">config_scenarios&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">如果默听荣和&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">如果自摸&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">如果立直荣和&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\t&lt;/span>&lt;span class="s2">如果立直自摸&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">original_config&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_tsumo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">config&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">is_riichi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">is_tsumo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">is_riichi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">scenario_message&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">config_scenarios&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_tsumo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">is_tsumo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">is_riichi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">is_riichi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">winning_tiles&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_tenpai_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scenario_message&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">print_possible_wins&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">winning_tiles&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_config&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">is_tsumo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">original_config&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">is_riichi&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">original_config&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;GLHF&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_shanten_improving_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Calculate all tiles that can improve the hand&amp;#39;s shanten number.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> This function goes through all possible tiles and checks
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> if adding each tile to the hand would improve the shanten number.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">current_shanten&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_shanten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">possible_improvements&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">full_tile_set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_generate_full_tile_set&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">tile&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">full_tile_set&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Create a new hand with the potential tile&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_hand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hand&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_shanten&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_shanten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Check if the shanten number has been reduced&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">new_shanten&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">current_shanten&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">possible_improvements&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">new_shanten&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Return a sorted list of improvements&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">possible_improvements&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">process_hand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">win_tile&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dora_indicators&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">dora_indicators&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">update_dora_indicators&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dora_indicators&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hand_score&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">win_tile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">shanten&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_shanten&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">shanten&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">list_all_possible_wins&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Shanten: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">shanten&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">calculate_shanten_improving_tiles&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Invalid hand length&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="image-tagger">Image Tagger&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">cv2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">supervision&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">sv&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">inference.models.utils&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">get_roboflow_model&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ImageProcessor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">image_files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_files&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">image_files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mahJongScorer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MahjongScorer&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get_scale_factor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">image_size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">reference_size&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">800&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">base_scale&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">0.8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">base_thickness&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Calculate the scale factor based on the image size compared to a reference size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">scale_factor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image_size&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">reference_size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">scaled_text_scale&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">base_scale&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">scale_factor&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">base_scale&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># Ensure minimum scale&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">scaled_text_thickness&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">base_thickness&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">scale_factor&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">base_thickness&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># Ensure minimum thickness&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">scaled_text_scale&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">scaled_text_thickness&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">process_images&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">resp&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">zip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cv2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">img&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Get scale and thickness based on image size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">text_scale&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">text_thickness&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_scale_factor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">shape&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">detections&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Detections&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">from_inference&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">resp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">bounding_box_annotator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">BoundingBoxAnnotator&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">thickness&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">text_thickness&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">label_annotator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">LabelAnnotator&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">text_scale&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">text_scale&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">text_thickness&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">text_thickness&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># conf_annotator = sv.PercentageBarAnnotator()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">annotated_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bounding_box_annotator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">annotate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scene&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">detections&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">detections&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">annotated_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">label_annotator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">annotate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scene&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">annotated_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">detections&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">detections&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># annotated_image = conf_annotator.annotate(scene=annotated_image, detections=detections)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sv&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot_image&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">annotated_image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hand&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">sorted&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">pred&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;class&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">pred&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">resp&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;predictions&amp;#39;&lt;/span>&lt;span class="p">]],&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mahJongScorer&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">process_hand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hand&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hand&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="p">[])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># except Exception as e:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># print(&amp;#34;Cannot score hand or calculaute shanten&amp;#34;, e)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Create an instance of the ImageProcessor class&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">processor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ImageProcessor&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">engine&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">image_files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">engine&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">infer&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Call the process_images method to process the images&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">processor&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">process_images&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Big Data System Design Pinterest</title><link>https://blog.xiax.xyz/p/big-data-system-design-pinterest/</link><pubDate>Mon, 25 Mar 2024 06:23:23 -0700</pubDate><guid>https://blog.xiax.xyz/p/big-data-system-design-pinterest/</guid><description>&lt;img src="https://blog.xiax.xyz/p/big-data-system-design-pinterest/Pinterest-2-1024x500.png" alt="Featured image of post Big Data System Design Pinterest" />&lt;h1 id="how-to-design-the-image-recommendation-engine-for-pinterest">How to Design the Image Recommendation Engine for Pinterest&lt;/h1>
&lt;h1 id="intro">Intro&lt;/h1>
&lt;p>We&amp;rsquo;re tasked with designing a scalable image recommendation system for Pinterest. It leverages the latest in big data and machine learning technologies, such as Kafka, Flink, Spark, Hadoop, Iceberg, Airflow, and Presto.&lt;/p>
&lt;h2 id="assumptions-for-the-technical-workflow">Assumptions for the Technical Workflow:&lt;/h2>
&lt;ul>
&lt;li>Pinterest&amp;rsquo;s platform gathers millions of user interactions every day, including image views, saves, comments, and likes.&lt;/li>
&lt;li>The image recommendation engine must adapt quickly to a user&amp;rsquo;s changing interests and provide real-time, personalized content.&lt;/li>
&lt;/ul>
&lt;h2 id="overall-architecture-design">Overall Architecture Design&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">User&lt;/span> &lt;span class="n">Apps&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Web&lt;/span> &lt;span class="n">Browsers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span> &lt;span class="n">Publish&lt;/span> &lt;span class="n">user&lt;/span> &lt;span class="n">interactions&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">clicks&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">views&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">etc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="n">Kafka&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span> &lt;span class="n">User&lt;/span> &lt;span class="n">interactions&lt;/span> &lt;span class="n">stream&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="n">Flink&lt;/span> &lt;span class="o">--------------&amp;gt;&lt;/span> &lt;span class="n">Perform&lt;/span> &lt;span class="n">real&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">time&lt;/span> &lt;span class="n">processing&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">update&lt;/span> &lt;span class="n">recommendation&lt;/span> &lt;span class="n">models&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span> &lt;span class="n">Write&lt;/span> &lt;span class="n">Flink&lt;/span> &lt;span class="n">results&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">    &lt;span class="n">Hadoop&lt;/span> &lt;span class="o">&amp;lt;---&amp;gt;&lt;/span> &lt;span class="n">Iceberg&lt;/span> &lt;span class="o">&amp;lt;-------------&lt;/span> &lt;span class="n">Airflow&lt;/span> &lt;span class="n">coordinating&lt;/span> &lt;span class="n">batch&lt;/span> &lt;span class="n">jobs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>        &lt;span class="o">|&lt;/span> &lt;span class="n">Tables&lt;/span>                 &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>        &lt;span class="o">|&lt;/span>                         &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&amp;lt;--&lt;/span> &lt;span class="n">Batch&lt;/span> &lt;span class="n">Processing&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">ETL&lt;/span> &lt;span class="n">via&lt;/span> &lt;span class="n">Spark&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span> &lt;span class="n">SQL&lt;/span> &lt;span class="n">queries&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">deep&lt;/span> &lt;span class="n">analytics&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Presto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="o">|&lt;/span> &lt;span class="n">Visualization&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Data&lt;/span> &lt;span class="n">Exploration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">     &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Business&lt;/span> &lt;span class="n">Analysts&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Data&lt;/span> &lt;span class="n">Scientists&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;pre class="mermaid">graph TB
    UA[User Apps &amp; Web Browsers] -->|Publish user interactions| K[Kafka]
    K -->|User interactions stream| F[Flink]
    F -->|Real-time processing| OS[Recommendation System]
    F -->|Write real-time results| H[Hadoop]
    
    SP[Spark for Batch Analysis &amp; Machine Learning] --> H
    A[Airflow] -->|Schedule &amp; orchestrate| SP
    
    H -->|Data stored in| I[Iceberg Tables]
    
    P[Presto] -->|SQL analytics queries| I
    
    B[Business Analysts &amp; Data Scientists] -->|Visualization &amp; Data Exploration| P
    
    %% Increase fontsize for all nodes
    classDef default fontsize:20px, color:#000, fill:#fff, stroke:#000;
&lt;/pre>
&lt;h3 id="technical-workflow">Technical Workflow:&lt;/h3>
&lt;h3 id="1-data-ingestion-apache-kafka">1. Data Ingestion (Apache Kafka):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Kafka Producers&lt;/strong>: Embed in the Pinterest app and web client. They serialize user activities into compact JSON or Avro formats and send events to &lt;code>user-interactions&lt;/code> topics, partitioned principally by user ID for efficient stream processing.&lt;/li>
&lt;li>&lt;strong>Kafka Brokers&lt;/strong>: Set up with topic partitions for redundancy and parallelism, and to ensure high availability and durability of the user interaction events. The partitioning allows for horizontal scalability in the face of increasing data volumes.&lt;/li>
&lt;/ul>
&lt;h3 id="2-real-time-stream-processing-apache-flink">2. Real-time Stream Processing (Apache Flink):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Streaming Jobs in Flink&lt;/strong>: These jobs use Flink&amp;rsquo;s rich CEP (Complex Event Processing) library to identify patterns of user interactions. They might capture sequences like frequent views of a particular image category, which triggers an immediate update to the user&amp;rsquo;s real-time recommendation profile.&lt;/li>
&lt;li>&lt;strong>Real-time Recommendation Model Updates&lt;/strong>: Take advantage of Flink&amp;rsquo;s state management to quickly adjust recommendation models. These models are stored in state backends, with Flink ensuring fault tolerance using its snapshot and checkpoint mechanisms.&lt;/li>
&lt;/ul>
&lt;h3 id="3-batch-processing-and-analysis-apache-spark">3. Batch Processing and Analysis (Apache Spark):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Feature Extraction and Machine Learning&lt;/strong>: Utilize Spark MLlib to periodically train collaborative filtering, clustering, and deep learning models. These models consume significant amounts of image metadata, user demographic information, and historical interaction logs to improve recommendation accuracy.&lt;/li>
&lt;li>&lt;strong>Data Preprocessing and ETL Jobs&lt;/strong>: Regularly extract, transform, and load fresh data from HDFS into the format required by machine learning models, performed by Spark&amp;rsquo;s SQL and Dataframe/Dataset APIs.&lt;/li>
&lt;/ul>
&lt;h3 id="4-workflow-orchestration-apache-airflow">4. Workflow Orchestration (Apache Airflow):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Machine Learning Pipeline Coordination&lt;/strong>: Use Airflow to manage dependencies among batch jobs, which includes pre-processing data, re-training recommendation models, and updating the production model serving layer.&lt;/li>
&lt;li>&lt;strong>Data Pipeline Monitoring&lt;/strong>: Allows for monitoring and scheduling of regular ETL jobs and ensures that model training occurs on an updated dataset.&lt;/li>
&lt;/ul>
&lt;h3 id="5-data-storage-hadoop--apache-iceberg">5. Data Storage (Hadoop + Apache Iceberg):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Raw Data Storage in HDFS&lt;/strong>: Acts as the central repository store for raw event data, user profiles, and image metadata. Optimized for sequential access patterns and leverages Hadoop&amp;rsquo;s robust data replication for fault tolerance.&lt;/li>
&lt;li>&lt;strong>Curated Data Layers with Iceberg&lt;/strong>: Iceberg tables store derived views, aggregated metrics, and machine learning features, optimizing the most common access patterns and providing ACID transactions to keep analytical data consistent even during updates.&lt;/li>
&lt;/ul>
&lt;h3 id="6-interactive-querying-presto">6. Interactive Querying (Presto):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Ad-Hoc Queries and Analysis&lt;/strong>: Presto allows data scientists to quickly explore datasets and run ad-hoc analytical queries which help in identifying new trends. They can perform joins across various Iceberg tables containing user interactions, image features, and models&amp;rsquo; output scores.&lt;/li>
&lt;/ul>
&lt;h3 id="7-data-lifecycle-and-schema-management">7. Data Lifecycle and Schema Management:&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Data Retention Policies&lt;/strong>: Implemented within Kafka and HDFS to manage and age data, ensuring storage costs are optimized without compromising the ability to retrain historical models.&lt;/li>
&lt;li>&lt;strong>Schema Evolution in Iceberg&lt;/strong>: Provides flexibility in evolving metadata structures and data schema as the formats of user interactions and image representations change over time.&lt;/li>
&lt;/ul>
&lt;h3 id="8-advanced-machine-learning-and-analytics-spark--mllib">8. Advanced Machine Learning and Analytics (Spark + MLlib):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Model Training and Evaluation&lt;/strong>: Utilizes large-scale, distributed processing capabilities of Spark to handle the computationally intensive task of machine learning model training, feature engineering, and historical data analysis.&lt;/li>
&lt;/ul>
&lt;h3 id="9-monitoring-and-governance">9. Monitoring and Governance:&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Comprehensive Monitoring&lt;/strong>: Collects metrics and logs from Kafka, Flink, Spark, and Presto jobs using tools like Prometheus and ELK Stack. These metrics are vital for identifying processing bottlenecks and ensuring the reliability of the data pipelines.&lt;/li>
&lt;li>&lt;strong>Data Governance and Compliance&lt;/strong>: Implemented across all data stores, with policies enforced to maintain data privacy, access controls, audit logging, and lineage tracking through tools like Apache Atlas and Ranger.&lt;/li>
&lt;/ul>
&lt;h2 id="technical-detail-followups">Technical Detail Followups&lt;/h2>
&lt;h3 id="kafka">Kafka&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
How does the Kafka architecture handle failures and ensure message durability?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Kafka uses a distributed commit log, where messages are appended and replicated across multiple brokers. Durability is ensured through these replications; if one broker fails, the others can provide the data. Kafka also uses a write-ahead log to disk, so messages are not lost in case of a system crash. A combination of in-sync replicas and acknowledgments from producers upon writes further fortifies the reliability of the message delivery.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="flink">Flink&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Can you expand on how Flink&amp;rsquo;s state management supports the real-time image recommendation feature?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Flink&amp;rsquo;s state management allows for the retention of relevant context during processing. For example, it can keep track of the current state of a user&amp;rsquo;s interaction pattern or a model&amp;rsquo;s parameters. This state is consistently checkpointed and stored in a persistent storage like HDFS or Amazon S3, so if there&amp;rsquo;s a failure, the application can resume from the latest successful checkpoint, minimizing data loss and computation.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="spark">Spark&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
How does Spark handle the iterative computation required for machine learning algorithms used in image recommendations?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Spark&amp;rsquo;s core abstraction, the Resilient Distributed Dataset (RDD), is well suited for iterative algorithms common in machine learning. This is because once an RDD is loaded into memory, it&amp;rsquo;s kept there for as long as necessary, drastically speeding up iterative data passes essential for algorithms like gradient descent. Spark&amp;rsquo;s MLlib also optimizes algorithms for distributed computing, partitioning the data across nodes to parallelize computations.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="airflow">Airflow&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
How does Apache Airflow help managing dependencies in the ETL workflows for the recommendation engine?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>In Airflow, workflows are expressed as DAGs, with each node representing a task and the edges representing dependencies between these tasks. Airflow can manage scheduling and running these tasks based on the specified dependencies, and it supports complex workflows where the execution order of tasks is critical. It also retries failed tasks, sends alerts, and can dynamically adjust workflows based on parameters or external triggers.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="hadoop--iceberg">Hadoop &amp;amp; Iceberg&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Describe how Hadoop and Apache Iceberg work together to manage the large datasets in this application.
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Hadoop provides the distributed storage (HDFS) and computing resources (YARN) needed to manage and process large-scale datasets, while Apache Iceberg integrates with HDFS to manage these datasets as structured tables. Iceberg adds layers like snapshotting, schema evolution, and transactional capabilities on top of the raw file system, which allows for efficient updates and querying of massive tables within HDFS.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="presto">Presto&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
What specific features of Presto make it a fit for the interactive querying requirements of data scientists?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Presto&amp;rsquo;s in-memory distributed query engine is designed for low-latency, interactive data analysis. It supports complex SQL queries, including aggregations, joins, and window functions that are essential for data scientists to explore and analyze big data quickly. Its ability to query data where it lives, without the need for data movement or transformation, streamlines analysis and reduces time to insight.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="data-lifecycle-and-schema-management">Data Lifecycle and Schema Management&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Can you delve into the specifics of how schema evolution is handled in a pipeline with mixed batch and real-time components?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Schema evolution must be managed carefully to ensure compatibility across different data models used by batch and real-time systems. Iceberg helps manage this by allowing schema changes to occur without downtime or requiring a rewrite of data. It maintains a history of schemas and supports schema enforcement and evolution with backward and forward compatibility. Data produced by real-time Flink jobs can evolve, and batch-based Spark jobs can accommodate these changes, as both can interact with the updated schema without interrupt to ongoing operations.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="advanced-machine-learning-and-analytics">Advanced Machine Learning and Analytics&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Explain the process of feature engineering for images in Spark and how it contributes to recommendation quality.
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Feature engineering in Spark for images involves extracting meaningful information from raw image data that can be used to train recommendation models. Using Spark&amp;rsquo;s MLlib, we could perform tasks like resizing images, normalizing pixel values, and extracting color histograms or texture patterns. MLlib can also be used to apply more sophisticated techniques like deep learning to extract higher-level features. These engineered features are critical for training effective recommendation models that can distinguish between different types of images and user preferences.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="monitoring-and-governance">Monitoring and Governance&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
How does the monitoring infrastructure support the operational stability of the image recommendation service?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>The monitoring infrastructure collects metrics and logs from all components of the pipeline. With tools like Prometheus, we can track system performance metrics in real time and set up alerts to notify if certain thresholds are exceeded. The ELK Stack is used for log analysis, which helps in diagnosing system problems and understanding user behavior. Together, they ensure the operational stability of the service by allowing us to rapidly identify and address issues as they arise, ensuring a smooth user experience.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="design-choice-follow-ups">Design Choice Follow ups&lt;/h2>
&lt;p>Here are more detailed Q&amp;amp;A examples focusing on the context of a real-world Pinterest-like image recommendation system, weighing the pros and cons of utilized technologies, and discussing alternatives:&lt;/p>
&lt;h3 id="kafka-1">Kafka&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Why choose Kafka over other messaging systems for real-time user interaction data ingestion?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Kafka is highly scalable and durable, making it ideal for handling the high-volume and high-velocity data streams produced by Pinterest&amp;rsquo;s user interaction events. Its distributed nature and partitioned topics provide fault tolerance and low-latency, which are crucial for real-time recommendation systems.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Kafka can be complex to set up and operate, particularly regarding cluster management and monitoring.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Apache Pulsar is an alternative that can offer similar scalability and durability, with native support for multi-tenancy and geo-replication, which could be beneficial for a global platform like Pinterest.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="flink-1">Flink&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
What makes Flink the preferred choice for real-time recommendation updates and not other stream processing frameworks?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Flink&amp;rsquo;s ability to handle complex event processing and maintain rich state management is unmatched. This enables more sophisticated real-time recommendation model updates and user interaction pattern analysis.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Flink&amp;rsquo;s complex event processing capabilities might be overkill for simpler interaction patterns or where latency is less of a concern.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Apache Storm is a simpler alternative for stream processing that can be considered if the processing needs are less complex. For tightly integrated Kafka environments, Kafka Streams might suffice for lightweight, real-time processing tasks.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="spark-1">Spark&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
In the context of feature extraction and machine learning for image recommendations, what are Spark&amp;rsquo;s advantages and disadvantages?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Spark&amp;rsquo;s MLlib for machine learning and its overall ecosystem for big data processing makes it versatile for handling the ETL, feature extraction, and model training workloads. It is efficient at iterative computation, which is essential in training machine learning models.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Spark&amp;rsquo;s in-memory processing model can be expensive, especially when dealing with very large datasets, as it requires a large amount of RAM.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Hadoop MapReduce can be a more cost-effective batch processing alternative in environments that are not latency-sensitive. For deep learning specific tasks, frameworks like TensorFlow or PyTorch could be integrated for GPU-accelerated processing.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="airflow-1">Airflow&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
What features does Airflow offer over other workflow management tools?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Airflow provides an expressive framework for defining complex dependencies and schedules in data processing pipelines. Its user-friendly UI and extensive monitoring capabilities make managing workflows much more straightforward.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Airflow can be resource-intensive and has a steeper learning curve, particularly for those unfamiliar with Python.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Luigi is a simpler Python-based workflow engine that might be appropriate for smaller-scale or less complex workflows. Apache NiFi offers a more GUI-driven approach for data flow management and could be preferable for teams looking for less code-intensive solutions.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="hadoop--iceberg-1">Hadoop &amp;amp; Iceberg&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Are there any drawbacks to using Hadoop and Iceberg, and what other systems could be used?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Hadoop&amp;rsquo;s HDFS is proven, reliable, and integrates well with big data processing tools. However, it might not be as cost-effective for storage compared to cloud object stores and is complex to manage. Iceberg provides excellent table management features, but is relatively new and has less community support compared to more mature tools.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Hadoop cluster requires significant setup and maintenance efforts. Iceberg is not as battle-tested as other formats and may still be evolving.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Cloud-based storage options like Amazon S3 or Azure Data Lake Storage offer similar scalability with lower operational overhead. Delta Lake is an alternative to Iceberg that provides similar ACID guarantees and seamless integration with Databricks’ platform.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="presto-1">Presto&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Q:&lt;/strong>
Presto is used for interactive querying, but what factors should we consider when choosing it, and are there any competitive technologies?
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong>&lt;/p>
&lt;p>Presto&amp;rsquo;s distributed architecture allows for fast query execution over large datasets, which is critical for data exploration and timely insights. However, for very large-scale data warehousing tasks and complex query workloads, Presto may not perform as well as dedicated solutions.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>&lt;/p>
&lt;p>Presto may not handle long-running analytical queries as effectively due to its design for ad-hoc querying. Also, it could be less cost-effective for persistent workloads.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>&lt;/p>
&lt;p>Apache Drill supports similar SQL queries on large-scale data but can be more forgiving on resource demands. Amazon Athena and Google BigQuery offer serverless querying options for those already invested in the respective cloud ecosystems.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Big Data System Design Uber Eats</title><link>https://blog.xiax.xyz/p/big-data-system-design-uber-eats/</link><pubDate>Mon, 25 Mar 2024 05:40:03 -0700</pubDate><guid>https://blog.xiax.xyz/p/big-data-system-design-uber-eats/</guid><description>&lt;img src="https://blog.xiax.xyz/p/big-data-system-design-uber-eats/Uber_Eats_Logo.jpg" alt="Featured image of post Big Data System Design Uber Eats" />&lt;h1 id="how-to-design-the-data-infra-for-uber-eats-order-tracking-page">How to Design the Data Infra for Uber Eats Order Tracking Page&lt;/h1>
&lt;h1 id="intro">Intro&lt;/h1>
&lt;p>A real world example to build scalable data analytics with tools like Kafka, Flink, Spark, Presto, Airflow, Iceberg, etc. Let&amp;rsquo;s delve into a more technical scenario that incorporates Kafka, Flink, Spark, Hadoop, Iceberg, Airflow, and Presto into a comprehensive real-time data processing and analytics pipeline:&lt;/p>
&lt;h2 id="assumptions-for-the-technical-workflow">Assumptions for the Technical Workflow:&lt;/h2>
&lt;ul>
&lt;li>An Uber Eats-like app tracks the location of drivers and communicates order details to users.&lt;/li>
&lt;li>The system must handle real-time processing, such as matching drivers with orders, and longer-term analytical processing, like optimizing driver routes and forecasting delivery times.&lt;/li>
&lt;/ul>
&lt;h2 id="overall-architecture-design">Overall Architecture Design&lt;/h2>
&lt;h3 id="simple-architecture-diagram">Simple Architecture Diagram&lt;/h3>
&lt;h4 id="ascii-style">Ascii Style&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Driver&lt;/span> &lt;span class="n">Apps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">Publish&lt;/span> &lt;span class="n">GPS&lt;/span> &lt;span class="n">locations&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Kafka&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span>\
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Driver&lt;/span> &lt;span class="n">locations&lt;/span> &lt;span class="n">stream&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">Flink&lt;/span> &lt;span class="o">----------&amp;gt;&lt;/span> &lt;span class="n">Compute&lt;/span> &lt;span class="n">aggregations&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Join&lt;/span> &lt;span class="n">streams&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Order&lt;/span> &lt;span class="n">events&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Manage&lt;/span> &lt;span class="n">stateful&lt;/span> &lt;span class="n">processing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Stream&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Order&lt;/span> &lt;span class="n">System&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">User&lt;/span> &lt;span class="n">Apps&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">Write&lt;/span> &lt;span class="n">Flink&lt;/span> &lt;span class="n">results&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Hadoop&lt;/span> &lt;span class="o">&amp;lt;--------/&lt;/span> &lt;span class="o">&amp;lt;--------------&lt;/span> &lt;span class="n">Airflow&lt;/span> &lt;span class="n">orchestrating&lt;/span> &lt;span class="n">tasks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">Data&lt;/span> &lt;span class="n">written&lt;/span> &lt;span class="n">back&lt;/span> &lt;span class="n">by&lt;/span> &lt;span class="n">Spark&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">other&lt;/span> &lt;span class="n">batch&lt;/span> &lt;span class="n">jobs&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Iceberg&lt;/span> &lt;span class="n">Tables&lt;/span> &lt;span class="o">&amp;lt;---------------------+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">SQL&lt;/span> &lt;span class="n">queries&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">analytics&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Presto&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">|&lt;/span> &lt;span class="n">Visualization&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="n">Reporting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Business&lt;/span> &lt;span class="n">Apps&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="mermaid-style">Mermaid Style&lt;/h4>
&lt;pre class="mermaid">graph TB
DA[Driver Apps] -->|Publish GPS locations| K[Kafka]
K -->|Driver locations stream| F[Flink]
K -->|Order events stream| F
F -->|Real-time processing| OA[Order System &amp; User Apps]
F -->|Write Flink results| H[Hadoop]
SP[Spark for Batch Analysis] -->|Write batch results| H
A[Airflow] -->|Schedule &amp; orchestrate| SP
H -->|Data management| I[Iceberg Tables]
P[Presto] -->|SQL queries| I
B[Business Apps] -->|Visualization &amp; Reporting| P
%% Define styling
classDef default fontsize:16px, color:#fff, fill:#000, stroke:#fff, stroke-width:2px;
linkStyle default stroke:white,stroke-width:1px;
&lt;/pre>
&lt;h3 id="technical-workflow">Technical Workflow:&lt;/h3>
&lt;h3 id="1-data-ingestion-apache-kafka">1. Data Ingestion (Apache Kafka):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Kafka Producers&lt;/strong>: The driver app constantly publishes GPS coordinates to a Kafka topic &lt;code>driver-locations&lt;/code>, using a producer client library. Each message might be keyed by driver ID to ensure location updates for a given driver go to the same partition for order.&lt;/li>
&lt;li>&lt;strong>Kafka Consumers&lt;/strong>: Other systems subscribe to the &lt;code>driver-locations&lt;/code> topic to receive updates. Additionally, consumer applications are set up for topics like &lt;code>order-events&lt;/code> that handle order placement, acceptance, and completions.&lt;/li>
&lt;li>Kafka topics are partitioned and replicated to ensure scalability and fault tolerance.&lt;/li>
&lt;/ul>
&lt;h3 id="2-real-time-stream-processing-apache-flink">2. Real-time Stream Processing (Apache Flink):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Flink Jobs&lt;/strong>: Flink jobs are configured to subscribe to &lt;code>driver-locations&lt;/code> and &lt;code>order-events&lt;/code>. They perform tasks such as:
&lt;ul>
&lt;li>Windowed aggregations to compute the latest location of each driver.&lt;/li>
&lt;li>Join operations between driver locations and pending orders to facilitate real-time matching and dispatching.&lt;/li>
&lt;li>Stateful processing for ETA calculations and sending notifications to customers via external systems when a driver is nearby.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="3-batch-processing-and-analysis-apache-spark">3. Batch Processing and Analysis (Apache Spark):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Spark Jobs&lt;/strong>: Scheduled batch Spark jobs are written in Scala or Python and deal with complex analytical tasks, including:
&lt;ul>
&lt;li>Training machine learning models on historical delivery data to predict delivery times (using MLlib).&lt;/li>
&lt;li>Aggregating delivery data nightly to create performance metrics per driver or per region.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="4-workflow-orchestration-apache-airflow">4. Workflow Orchestration (Apache Airflow):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Airflow DAGs (Directed Acyclic Graphs)&lt;/strong>: Define the dependent jobs and workflows that orchestrate processing tasks. An Airflow DAG might include:
&lt;ul>
&lt;li>A task to run a Spark job that rebuilds machine learning models.&lt;/li>
&lt;li>Another task to batch-process the day&amp;rsquo;s data and update Iceberg tables.&lt;/li>
&lt;li>Scheduling and triggering Flink jobs for real-time streaming when needed.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="5-data-storage-hadoop--apache-iceberg">5. Data Storage (Hadoop + Apache Iceberg):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>HDFS&lt;/strong>: Raw data from Kafka is landed into HDFS, and processed data is stored there for long-term historical analysis.&lt;/li>
&lt;li>&lt;strong>Iceberg Tables&lt;/strong>: Transactional data tables managed by Iceberg provide consistent snapshots of large-scale datasets and support schema evolution for the raw Kafka data and the results of Spark jobs.&lt;/li>
&lt;/ul>
&lt;h3 id="6-interactive-querying-presto">6. Interactive Querying (Presto):&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Presto SQL Queries&lt;/strong>: Analysts use Presto to perform SQL queries on stored Hadoop data and Iceberg tables to gain insights or create real-time dashboards. Example queries might include:
&lt;ul>
&lt;li>SQL to join today&amp;rsquo;s real-time data with historical trends.&lt;/li>
&lt;li>Aggregation queries to analyze delivery efficiency across different areas.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="7-data-lifecycle-and-schema-management">7. Data Lifecycle and Schema Management:&lt;/h3>
&lt;ul>
&lt;li>Iceberg table partitioning is configured for efficient data retrieval, e.g., by time window or geographical region.&lt;/li>
&lt;li>Data retention policies are configured in Kafka to govern how long data is kept, considering storage costs and compliance requirements.&lt;/li>
&lt;li>Iceberg&amp;rsquo;s schema evolution allows for seamless transitions when altering data structures or incorporating new data sources.&lt;/li>
&lt;/ul>
&lt;h3 id="8-advanced-machine-learning-and-analytics-spark--mllib">8. Advanced Machine Learning and Analytics (Spark + MLlib):&lt;/h3>
&lt;ul>
&lt;li>Historical data in Iceberg tables is used to train and refine predictive models for delivery ETA, taking advantage of features like lookback windows and seasonal trends.&lt;/li>
&lt;li>Airflow DAGs keep model training and evaluations consistent, reproducible, and on schedule.&lt;/li>
&lt;/ul>
&lt;h3 id="9-monitoring-and-governance">9. Monitoring and Governance:&lt;/h3>
&lt;ul>
&lt;li>Comprehensive logging is set up for all components, including Kafka brokers, Flink job managers, and Spark driver/executor processes.&lt;/li>
&lt;li>A monitoring solution (such as Prometheus with Grafana) watches over the health and performance of the infrastructure, ensuring SLAs are met.&lt;/li>
&lt;li>Data governance is enforced via policies and access controls for sensitive data in HDFS and Iceberg, audited by tools such as Apache Ranger.&lt;/li>
&lt;/ul>
&lt;p>The synergy in such a technical workflow allows an Uber Eats-like service to leverage strengths from each tool — Kafka for ingestion, Flink for real-time processing, Spark for batch processing and ML, Airflow for orchestration, Iceberg for managing large-scale data tables, and Presto for interactive querying. This enables real-time communication to users and drivers while also providing a platform for advanced analytics and strategic decision-making based on historical and current data.&lt;/p>
&lt;h2 id="technical-detail-followups">Technical Detail Followups&lt;/h2>
&lt;h3 id="kafka">Kafka&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How do you ensure data consistency in your Kafka cluster?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Kafka ensures data consistency by replicable partitions, where each partition has one leader and multiple in-sync replicas (ISRs). The leader handles all the read and write requests for that partition, and ISRs replicate the leader&amp;rsquo;s data. Consumers typically read from the leader to ensure they receive the most up-to-date records.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Can you explain the role of Zookeeper in a Kafka ecosystem?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Zookeeper plays a critical role in Kafka&amp;rsquo;s architecture; it manages and coordinates Kafka brokers. It&amp;rsquo;s responsible for leader election for partitions, managing configuration information, and maintaining a list of Kafka brokers and topics, as well as their status.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="flink">Flink&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> What advantages does Flink provide when dealing with stateful computations?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Flink offers robust state management and fault tolerance for stateful computations in streaming data. It maintains a consistent snapshot of all state throughout an application’s execution, which can be recovered in case of a failure. Flink&amp;rsquo;s checkpointing and savepoints feature are key for ensuring exactly-once processing semantics.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How does Flink handle event time and out-of-order events?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Flink features an event time concept that deals with the time at which events actually occurred, as opposed to when they are processed by the system. With watermarks, which are special types of events that specify the progress of event time, Flink is capable of handling out-of-order events or late-arriving data.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="spark">Spark&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> What is the difference between RDDs, DataFrames, and Datasets in Spark?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> RDD (Resilient Distributed Dataset) is the fundamental data structure in Spark - an immutable distributed collection of objects that can be processed in parallel. DataFrames are a collection of RDDs, but with a schema, which provides a higher level abstraction and optimization opportunities through Catalyst optimizer. Datasets are a type-safe version of DataFrames, allowing users to work with strongly-typed data collected as JVM objects.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How does Spark achieve fault tolerance?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Spark achieves fault tolerance through its immutable data structure and lineage graph. In case of a partition failure, Spark can recompute the lost partition by replaying the transformations used to build the lineage of the RDD. This significantly reduces the need for data replication for fault tolerance purposes.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="hadoop">Hadoop&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> What are some of the core components of a Hadoop ecosystem?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> The core of Hadoop consists of the storage layer, HDFS (Hadoop Distributed File System), for reliable storage of massive datasets, and YARN (Yet Another Resource Negotiator), for cluster resource management, and the MapReduce programming model for processing large datasets in parallel.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How is data stored and processed in Hadoop?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> In Hadoop, data is stored in HDFS across a distributed file system that spans the nodes in a Hadoop cluster. Data is processed using a MapReduce job where the data is first mapped, sorted/shuffled, and then reduced to produce an output - each of these steps can run in parallel across the cluster&amp;rsquo;s nodes.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="iceberg">Iceberg&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> What is Apache Iceberg and how does it help with managing large data sets?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Apache Iceberg is a table format for large data sets that enables high-performance queries in distributed computing environments. It adds more structure and optimization to data storage, providing benefits like snapshot isolation, schema evolution, and efficient querying through hidden partitioning.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Can Iceberg tables work with both batch and streaming data?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Yes, Iceberg tables are designed to support both batch and stream processing workloads seamlessly. They can be read and written to using traditional batch operations or incrementally using streaming workloads, thus, providing flexibility and ensuring up-to-date views of data.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="airflow">Airflow&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> What are the benefits of using Apache Airflow for workflow orchestration?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Apache Airflow provides a highly customizable platform for scheduling and coordinating complex data pipelines. It enables developers to define workflows as code, which allows for easy versioning, testing, and reusability. Its rich user interface aids in visualizing workflows, monitoring job progress, and diagnosing issues.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How do you ensure that a task in Airflow is idempotent?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> To make sure that a task in Airflow is idempotent - producing the same result regardless of how many times it’s executed - you&amp;rsquo;d structure your tasks so that the output depends solely on the inputs and the code at execution time. Also, using Airflow&amp;rsquo;s extensive logging and external systems for state management can help ensure idempotency.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="presto">Presto&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why would you use Presto over other SQL-on-Hadoop engines?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Presto is designed for low-latency queries and is generally faster than other SQL-on-Hadoop engines due to its distributed architecture and query execution strategies. Unlike others, Presto does not use MapReduce; it processes data using an in-memory pipeline execution model which is significantly faster.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How does Presto interact with different data sources, such as Iceberg or Kafka?&lt;/p>
&lt;ul>
&lt;li>&lt;strong>A:&lt;/strong> Presto has a connector architecture that allows it to interact with various data sources. For Iceberg, the Presto Iceberg connector provides support for reading from and writing to Iceberg tables. For Kafka, the Presto Kafka connector allows Presto to query Kafka topics directly as if they were tables. This flexibility makes it easy to combine and query data across different storage systems.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="design-choice-follow-ups">Design Choice Follow ups&lt;/h2>
&lt;h3 id="kafka-1">Kafka&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why Kafka for tracking driver locations in real time and not other systems like RabbitMQ or ActiveMQ?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Kafka is built for high throughput and is capable of handling the vast volume of location updates generated by drivers—potentially millions of messages per second. Unlike RabbitMQ or ActiveMQ, Kafka excels at handling large streams of data efficiently, making it ideal for real-time analytics use cases. Also, Kafka&amp;rsquo;s durable storage model allows us to reprocess historical data if needed.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - High throughput and scalability.
    - Built-in partitioning and replication.
    - Fault tolerance.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Complexity in setup and management.
    - Broker-centric storage with less queuing flexibility.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - RabbitMQ or Pulsar for simpler setups or additional messaging features but with potential scalability limitations.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="flink-1">Flink&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why use Apache Flink for real-time processing of driver locations?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Flink provides low-latency, accurate stream processing, which is critical for the driver location updates to reach customers in a timely manner. It&amp;rsquo;s also good at handling stateful computations, like aggregating driver locations over windows of time. Apache Flink was chosen over alternatives like Apache Storm due to its greater throughput and ease of state management. However, we also considered Apache Kafka Streams for its tight integration with Kafka, but Flink offered more advanced windowing and state management features.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - High performance and low latency.
    - Advanced state management.
    - Effective event-time handling.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Complexity for simpler stream processing needs.
    - Possible overkill for less demanding tasks.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Apache Storm for competent stream processing or Kafka Streams for Kafka-centric applications.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="spark-1">Spark&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why is Apache Spark preferred for batch processing and ML over other frameworks?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Spark provides a robust MLlib for machine learning, which we use to predict delivery times. It&amp;rsquo;s optimized for iterative algorithms, such as those used in machine learning, and its in-memory computing capabilities speed up processing. This makes it highly effective for our driver location data analysis. An alternative could be Hadoop MapReduce, but it&amp;rsquo;s a lot slower and less suited for complex analytics and ML tasks that Spark excels at.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - Fast performance with in-memory computing.
    - Comprehensive MLlib for machine learning tasks.
    - Unified APIs for diverse workloads.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Resource-intensive, especially for memory.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Hadoop MapReduce for cost-effective batch processing or cloud solutions like AWS EMR for managed services.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="hadoop-hdfs">Hadoop (HDFS)&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why prefer HDFS over cloud object storage like Amazon S3?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> HDFS offers high throughput and is well-suited for the big data ecosystem, particularly with other Hadoop components. It integrates seamlessly with our data processing engines like Spark and our metadata management through Iceberg. While cloud object storage solutions are great for scalability and cost-effectiveness, HDFS gives us more control over our data locality and performance, which is important for our time-sensitive analytical workloads.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - Smooth integration with Hadoop-based tools.
    - High throughput and performance.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Complexity in management and operations.
    - Less elasticity than cloud storage.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Cloud solutions like Amazon S3 for scalability and simple operation.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="iceberg-1">Iceberg&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> How does Apache Iceberg improve large data table management and what are other options?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Iceberg offers reliable, scalable management of big data tables, addressing issues with older file formats like concurrency, versioning, and schema evolution. Iceberg integrates well with Spark and Flink, allowing us to easily manage table formats on HDFS. One alternative is Apache Hive, but it has limitations with metadata scaling which Iceberg has been designed to overcome.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - Efficient metadata management.
    - Seamless schema evolution.
    - Performance optimization through hidden partitioning.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Less mature compared to formats like Parquet.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Apache Hive for a traditional data warehouse approach, or Delta Lake for ACID transactions and building data pipelines.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="airflow-1">Airflow&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why Airflow over other workflow tools?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Airflow excels at defining, scheduling, and monitoring complex data pipelines. Its ability to code workflows as Directed Acyclic Graphs (DAGs) offers flexibility and transparency we need. Moreover, Airflow&amp;rsquo;s user interface and community support are excellent. As an alternative, we considered Luigi and Apache NiFi, but Airflow&amp;rsquo;s abilities to integrate with our data stack and intuitive UI made it the ideal choice for us.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - Flexibility with a Python-based programming model.
    - Rich UI for management and monitoring.
    - Broad integration with data processing tools.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Potential resource intensity for simple needs.
    - Learning curve for non-Python familiar developers.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Luigi for simpler Python-centric workflows or Apache NiFi for a more visual-centric approach.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="presto-1">Presto&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Q:&lt;/strong> Why Presto for interactive querying against other technologies?&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>A:&lt;/strong> Presto&amp;rsquo;s distributed in-memory architecture enables us to perform high-speed, ad-hoc queries directly on our data lake without data movement. It&amp;rsquo;s flexible and supports a wide range of data sources, maintaining high performance for interactive analytics. We considered Apache Drill, but Presto&amp;rsquo;s SQL compatibility and performance made it the better fit for our diverse data requirements.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Pros:&lt;/strong>
    - Fast querying over various data sources.
    - Strong SQL support for diverse BI tools.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Cons:&lt;/strong>
    - Costly for large datasets due to in-memory processing.
    - Suboptimal for extended, complex queries.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Alternatives:&lt;/strong>
    - Apache Drill for similar querying capabilities or managed cloud services like Amazon Athena for less operational involvement.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Iceberg 101 - Chapter 1 The Problem &amp; Solution Behind Iceberg's Origin</title><link>https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/</link><pubDate>Sun, 24 Mar 2024 02:42:56 -0700</pubDate><guid>https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/</guid><description>&lt;img src="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg.webp" alt="Featured image of post Iceberg 101 - Chapter 1 The Problem &amp; Solution Behind Iceberg's Origin" />&lt;h1 id="the-problem--solution-behind-icebergs-origin">The Problem &amp;amp; Solution Behind Iceberg&amp;rsquo;s Origin&lt;/h1>
&lt;aside>
💡 — What’s the problem and Why Iceberg?
&lt;/aside>
&lt;h2 id="what-is-a-data-lake">What is a data lake?&lt;/h2>
&lt;ul>
&lt;li>A data lake is a central location that holds a large amount of data in its native, raw format.&lt;/li>
&lt;li>Compared to a hierarchical data warehouse, which stores data in files or folders, a data lake uses a flat architecture and object storage to store the data.‍&lt;/li>
&lt;li>Object storage stores data with metadata tags and a unique identifier, which makes it easier to locate and retrieve data across regions, and improves performance.&lt;/li>
&lt;li>By leveraging inexpensive object storage and open formats, data lakes enable many applications to take advantage of the data.&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/datalake_comparison.png"
width="1214"
height="1252"
srcset="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/datalake_comparison_huaecf6477792216b678d3d0355414fc00_241512_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/datalake_comparison_huaecf6477792216b678d3d0355414fc00_241512_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Datalake Comparison"
class="gallery-image"
data-flex-grow="96"
data-flex-basis="232px"
>&lt;/p>
&lt;h2 id="whats-a-table-format">What’s a table format?&lt;/h2>
&lt;ul>
&lt;li>A way to organize a datalake’s files to present them as a single table&lt;/li>
&lt;li>A way to answer the question — what data is in this table&lt;/li>
&lt;li>So user can query a bunch of files in a data lake (a bunch of files) just like a database or data warehouse
&lt;ul>
&lt;li>Extension on datalake
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.databricks.com/discover/data-lakes" target="_blank" rel="noopener"
>https://www.databricks.com/discover/data-lakes&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="the-old-de-facto-standard--hive">The old de-facto standard — Hive&lt;/h2>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/hive_defacto.png"
width="1307"
height="477"
srcset="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/hive_defacto_hu18ec1c92615a0c15ef327e50199a17ce_146804_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/hive_defacto_hu18ec1c92615a0c15ef327e50199a17ce_146804_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Hive Defacto"
class="gallery-image"
data-flex-grow="274"
data-flex-basis="657px"
>&lt;/p>
&lt;h3 id="origin-of-hive">Origin of Hive&lt;/h3>
&lt;ul>
&lt;li>Originated from Facebook.&lt;/li>
&lt;li>In early days of datalakes, engineers have to write map reduce java code to interact with their Hadoop cluster.&lt;/li>
&lt;li>Hive is create to make life easier for people, instead of having to write java code, Hive translate the SQL into MapReduce scripts.&lt;/li>
&lt;li>To do that, we need a way to recognize files as tables.&lt;/li>
&lt;li>The approach Hive took is a directory-based approach. Where it would just treat a folder on a Hadoop cluster as a table. And subfolders will be partitions.&lt;/li>
&lt;/ul>
&lt;h3 id="pros-of-hive">Pros of Hive&lt;/h3>
&lt;ul>
&lt;li>More efficient access patterns than full-table scans for every query (Better latency &amp;amp; Cost)&lt;/li>
&lt;li>Works with basically every engine since it’s been the de-facto standard for so long.&lt;/li>
&lt;li>File format agnostic&lt;/li>
&lt;li>Atomically update a whole partition (ACID guanrantee)&lt;/li>
&lt;li>Single, central answer to “what data is in this table” for the whole datalake ecosystem&lt;/li>
&lt;/ul>
&lt;h3 id="cons-of-hive">Cons of Hive&lt;/h3>
&lt;ul>
&lt;li>Smaller updates are very inefficient&lt;/li>
&lt;li>No way to change data in multiple partitions safely&lt;/li>
&lt;li>In practice, Unsafe concurrent partition modifications&lt;/li>
&lt;li>All of the directory listings needed for large tables take a long time.
&lt;ul>
&lt;li>Extra effort needed to speed up a query: indexing, more processing power, materializing&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Users have to know the physical Layout of the table to take advantage of performance benefits of partitioning&lt;/li>
&lt;li>Hive table statics are often stale, and updating statics(with Analyze) is very slow&lt;/li>
&lt;/ul>
&lt;h2 id="how-to-resolve-the-issues-with-hive">How to resolve the issues with Hive?&lt;/h2>
&lt;p>Netflix having issues with Hive and in need of a new table format.&lt;/p>
&lt;h3 id="netflixs-goals">Netflix’s Goals&lt;/h3>
&lt;ul>
&lt;li>Table correctness/consistency&lt;/li>
&lt;li>Faster query planning and execution&lt;/li>
&lt;li>Allow users to not worry about the physical layout of the table&lt;/li>
&lt;li>Table evolution support. (Flexible schema, partitioning changes)&lt;/li>
&lt;li>Achieve all above at scale.&lt;/li>
&lt;/ul>
&lt;h3 id="the-answer--iceberg-and-what-is-it">The answer — Iceberg and what is it&lt;/h3>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_files.png"
width="1063"
height="197"
srcset="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_files_hu1b7f01b24a620f04fdd21c8d5bb12f2e_51110_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_files_hu1b7f01b24a620f04fdd21c8d5bb12f2e_51110_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="iceberg_files"
class="gallery-image"
data-flex-grow="539"
data-flex-basis="1295px"
>&lt;/p>
&lt;h3 id="what-is-iceberg-">What is Iceberg? ✅&lt;/h3>
&lt;ul>
&lt;li>Table format specification&lt;/li>
&lt;li>A set of APIs and libraries for interaction with that specification
&lt;ul>
&lt;li>These libraries are leveraged in other engines and tools that allow them to interact with Iceberg tables&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="what-iceberg-is-not-">What Iceberg is not? ❌&lt;/h3>
&lt;ul>
&lt;li>Not a storage engine&lt;/li>
&lt;li>Not an execution engine&lt;/li>
&lt;li>Not a service&lt;/li>
&lt;/ul>
&lt;h3 id="design-benefits-of-iceberg">Design Benefits of Iceberg&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>Efficiently make smaller updates&lt;/p>
&lt;ul>
&lt;li>Making changes at the file level instead of directory level&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Snapshot Isolation for transactions&lt;/p>
&lt;ul>
&lt;li>Reads and writes don’t interfere with each other and all writes are atomic
&lt;ul>
&lt;li>Anytime the table changes, a snapshot is created.&lt;/li>
&lt;li>Any read will be on the same latest snapshot&lt;/li>
&lt;li>Any write will result in a sequence of write&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Concurrent writes&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Faster planning and execution (Fresh metadata and statistics)&lt;/p>
&lt;ul>
&lt;li>List of files defined on the write-side&lt;/li>
&lt;li>Column stats in manifest files on the write-side&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Reliable metrics for CBOs&lt;/p>
&lt;ul>
&lt;li>Done on write instead of “infrequent” expensive read job (Analyze)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Abstract the physical, expose a logical view&lt;/p>
&lt;ul>
&lt;li>Hidden partitioning, ppl don’t need to care how the files are stored physically, they just need to know the logical layout as it’s stored in the manifest (list of files and organization of these files)&lt;/li>
&lt;li>Enables Compaction
&lt;ul>
&lt;li>built-in tools to optimize small files comes from streaming → better performance&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Tables can change over time (schema and partitions)&lt;/li>
&lt;li>Can rollback snapshots&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Rich schema evolution support&lt;/p>
&lt;/li>
&lt;li>
&lt;p>All engines see changes immediately and can work together&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Community&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_community.png"
width="2171"
height="1074"
srcset="https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_community_hudac480157649b8c789a69fffd54409e6_831978_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/iceberg-101-chapter-1-the-problem-solution-behind-icebergs-origin/iceberg_community_hudac480157649b8c789a69fffd54409e6_831978_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Iceberg Community"
class="gallery-image"
data-flex-grow="202"
data-flex-basis="485px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="reference">Reference:&lt;/h2>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.youtube.com/watch?v=cI9zu5Rk_bQ" target="_blank" rel="noopener"
>Apache Iceberg Tutorial: Learn the Problem &amp;amp; Solution Behind Iceberg&amp;rsquo;s Origin Story&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.databricks.com/discover/data-lakes" target="_blank" rel="noopener"
>Databrick&amp;rsquo;s take on datalakes&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.databricks.com/glossary/materialized-views" target="_blank" rel="noopener"
>Databrick&amp;rsquo;s take on materialized views&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>日麻 牌效率学习</title><link>https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/</link><pubDate>Sun, 24 Mar 2024 03:22:16 -0700</pubDate><guid>https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/</guid><description>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_4.png" alt="Featured image of post 日麻 牌效率学习" />&lt;h1 id="立直麻将-牌效率学习-门清一般型">立直麻将 牌效率学习 (门清一般型)&lt;/h1>
&lt;p>&lt;a class="link" href="https://www.youtube.com/playlist?list=PLAOMOhCKGh68V0R4NGHL5u0WKkd9BL-PM" target="_blank" rel="noopener"
>(大概)很好懂的牌效率&lt;/a>&lt;/p>
&lt;h2 id="chapter-1-数牌-顺子和搭子">Chapter 1 数牌: 顺子和搭子&lt;/h2>
&lt;ul>
&lt;li>Basics
&lt;ul>
&lt;li>面子 = 顺子+刻子&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>顺子 &amp;raquo; 刻字
&lt;ul>
&lt;li>顺子牌效率搭子 → 可以变成顺子的牌
&lt;ul>
&lt;li>两面 &amp;raquo; 崁张 &amp;raquo; 边张&lt;/li>
&lt;li>数字强度
&lt;ul>
&lt;li>
&lt;p>34567 &amp;gt; 28 &amp;gt; 19&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled.png"
width="1308"
height="1158"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_huca92ed48784c1f0f19266ded51658572_2384805_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_huca92ed48784c1f0f19266ded51658572_2384805_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="112"
data-flex-basis="271px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="chapter-2-字牌-序盘处理">Chapter 2 字牌 序盘处理&lt;/h2>
&lt;ul>
&lt;li>字牌组成面子的能力弱于数牌&lt;/li>
&lt;li>字牌出现的数量越多, 价值急剧下降&lt;/li>
&lt;li>单张字牌的价值
&lt;ul>
&lt;li>
&lt;p>比如 &lt;code>1,4&lt;/code> &lt;code>6,9&lt;/code> 这样的组合, 属于有效牌重复, 价值甚至低于客风牌&lt;/p>
&lt;/li>
&lt;li>
&lt;p>役牌的价值一般高于19牌, 如果需要役则价值更高&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_1.png"
width="1452"
height="926"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_1_hua4d845298493ad1cafe2f99966b5350f_1207578_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_1_hua4d845298493ad1cafe2f99966b5350f_1207578_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="156"
data-flex-basis="376px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="chapter-3-对子">Chapter 3 对子&lt;/h2>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_2.png"
width="2148"
height="1008"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_2_hu44b5a4bac753b4f0448c38730af85aeb_2692803_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_2_hu44b5a4bac753b4f0448c38730af85aeb_2692803_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="213"
data-flex-basis="511px"
>&lt;/p>
&lt;h2 id="chapter-4-向听数-有效牌-五种听牌型">Chapter 4 向听数, 有效牌, 五种听牌型&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>向听数&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_3.png"
width="2204"
height="1030"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_3_hu89bfc7fc8157a96deede0eeb89fcfd9b_2863110_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_3_hu89bfc7fc8157a96deede0eeb89fcfd9b_2863110_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="213"
data-flex-basis="513px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_4.png"
width="2230"
height="1136"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_4_hu0e8d761353474b88d3b7cf36e300ef14_3311421_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_4_hu0e8d761353474b88d3b7cf36e300ef14_3311421_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="196"
data-flex-basis="471px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_5.png"
width="2366"
height="1110"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_5_hu3232595367cf711fc2965d1e02cc05ad_2719077_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_5_hu3232595367cf711fc2965d1e02cc05ad_2719077_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="213"
data-flex-basis="511px"
>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>进张 → 可以使进入下一个向听阶段的牌&lt;/p>
&lt;/li>
&lt;li>
&lt;p>改良 → 使进张牌数增加&lt;/p>
&lt;/li>
&lt;li>
&lt;p>有效牌 = 进张+改良&lt;/p>
&lt;/li>
&lt;li>
&lt;p>听牌型&lt;/p>
&lt;ul>
&lt;li>两面听 → 8张&lt;/li>
&lt;li>双碰(两对) / 崁张 / 边张 → 4张&lt;/li>
&lt;li>单骑 → 3张, 但是转张自由度很高&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>复合听牌型&lt;/p>
&lt;ul>
&lt;li>
&lt;p>双复合&lt;/p>
&lt;ul>
&lt;li>
&lt;p>双单骑&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_6.png"
width="2164"
height="886"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_6_hu2dc8288c4a3ee3eb14f88e4510e18bba_2291519_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_6_hu2dc8288c4a3ee3eb14f88e4510e18bba_2291519_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="244"
data-flex-basis="586px"
>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>螺丝型&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_7.png"
width="2214"
height="1008"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_7_hubfbdb899bcd6508999f4c95aec707c19_2987596_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_7_hubfbdb899bcd6508999f4c95aec707c19_2987596_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="219"
data-flex-basis="527px"
>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>顺子附近的数牌都可以让我们转更好的听牌型&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_8.png"
width="2286"
height="1058"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_8_hu72d8200e856e4a4ad75d1bc9e905681a_2855759_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_8_hu72d8200e856e4a4ad75d1bc9e905681a_2855759_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="216"
data-flex-basis="518px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>复合三面听 (暗刻复合型就很舒服&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_9.png"
width="1266"
height="918"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_9_hue18b7d841d122293fd9c507b8d49dd27_1538876_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_9_hue18b7d841d122293fd9c507b8d49dd27_1538876_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="137"
data-flex-basis="330px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_10.png"
width="2008"
height="1096"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_10_hucedc1070c164b1a5e4361e642d05d59d_2819360_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_10_hucedc1070c164b1a5e4361e642d05d59d_2819360_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="183"
data-flex-basis="439px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_11.png"
width="2208"
height="914"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_11_hub02bdbacb8d44238e1835febbd71fabf_2879207_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_11_hub02bdbacb8d44238e1835febbd71fabf_2879207_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="241"
data-flex-basis="579px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_12.png"
width="2110"
height="944"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_12_hu2cd9da095cf615b9f2b7403f42afa29f_2305937_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_12_hu2cd9da095cf615b9f2b7403f42afa29f_2305937_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="223"
data-flex-basis="536px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>总结&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_13.png"
width="2226"
height="1194"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_13_huf10bee256935f95ada197146a23bbbf6_3443975_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_13_huf10bee256935f95ada197146a23bbbf6_3443975_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="447px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_14.png"
width="2248"
height="1186"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_14_huc345a9f1b50e3925dbfc963dd21d8723_3321561_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_14_huc345a9f1b50e3925dbfc963dd21d8723_3321561_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="189"
data-flex-basis="454px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_15.png"
width="2344"
height="1224"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_15_hu4341534e140acca61bda1adf758c209b_3419673_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_15_hu4341534e140acca61bda1adf758c209b_3419673_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="191"
data-flex-basis="459px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_16.png"
width="2132"
height="890"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_16_hudb584757781517678e932a3b4490ab12_2198165_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_16_hudb584757781517678e932a3b4490ab12_2198165_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="239"
data-flex-basis="574px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_17.png"
width="2120"
height="856"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_17_huc2ab4547e07c5cf4ebe6eb331d20662e_2099242_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_17_huc2ab4547e07c5cf4ebe6eb331d20662e_2099242_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="247"
data-flex-basis="594px"
>&lt;/p>
&lt;p>&lt;img src="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_18.png"
width="2224"
height="1026"
srcset="https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_18_hu521dcd27f834c899782deb430bb94a8c_2677285_480x0_resize_box_3.png 480w, https://blog.xiax.xyz/p/%E6%97%A5%E9%BA%BB-%E7%89%8C%E6%95%88%E7%8E%87%E5%AD%A6%E4%B9%A0/imgs/Untitled_18_hu521dcd27f834c899782deb430bb94a8c_2677285_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Untitled"
class="gallery-image"
data-flex-grow="216"
data-flex-basis="520px"
>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="chapter-5-对子复合听牌-补强牌">Chapter 5 对子复合听牌, 补强牌&lt;/h2></description></item><item><title>Comparing Dockerized App Deployment Platform (To be Written)</title><link>https://blog.xiax.xyz/p/comparing-dockerized-app-deployment-platform-to-be-written/</link><pubDate>Sat, 23 Mar 2024 14:01:53 +0000</pubDate><guid>https://blog.xiax.xyz/p/comparing-dockerized-app-deployment-platform-to-be-written/</guid><description>&lt;img src="https://blog.xiax.xyz/p/comparing-dockerized-app-deployment-platform-to-be-written/docker.png" alt="Featured image of post Comparing Dockerized App Deployment Platform (To be Written)" /></description></item><item><title>How to recreate Split Wise's Simplify Debt Feature? (Draft, Work in Progress)</title><link>https://blog.xiax.xyz/p/how-to-recreate-split-wises-simplify-debt-feature-draft-work-in-progress/</link><pubDate>Sat, 23 Mar 2024 14:01:53 +0000</pubDate><guid>https://blog.xiax.xyz/p/how-to-recreate-split-wises-simplify-debt-feature-draft-work-in-progress/</guid><description>&lt;img src="https://blog.xiax.xyz/p/how-to-recreate-split-wises-simplify-debt-feature-draft-work-in-progress/split_wise.png" alt="Featured image of post How to recreate Split Wise's Simplify Debt Feature? (Draft, Work in Progress) " />&lt;h1 id="simplify-debts">Simplify Debts&lt;/h1>
&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>How to recreate the simplify debt from split wise&lt;/p>
&lt;h2 id="what-is-simplify-debts">What is Simplify Debts?&lt;/h2>
&lt;h2 id="code-demo-dfs-approach">Code Demo DFS Approach&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">collections&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">defaultdict&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">math&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">O(n!) DFS Alogirthm
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Solution&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">minTransfers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">input_transactions&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">balance&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">defaultdict&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transactions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">trans&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">input_transactions&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">amount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">trans&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;amount&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">payer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">trans&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;payer&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">payees&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">trans&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;payees&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Split the transaction amount among the payees (excluding the payer)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">per_person&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">payees&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">payee&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">payees&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transactions&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">payer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">payee&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">per_person&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">from_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">to&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">amt&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">transactions&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">balance&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">to&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">amt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">balance&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">from_&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="n">amt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Filter out zero balances and create a list of non-zero balances&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">debts&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">balance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">people&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">filter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">lambda&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">balance&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">balance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Helper function to find the min transactions to settle starting from &amp;#39;index&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">backtrack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Skip already settled accounts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">debts&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">debts&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[],&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">min_txns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">math&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">inf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">min_trans_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">debts&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Pruning. debts[j] must be non zero and of different sign&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Temporarily settle the debt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">next_trans_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">num_txns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">backtrack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># If better solution found, update the result&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">num_txns&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">min_txns&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">min_txns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">num_txns&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">amt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Determine the payer and payee based on the sign of debts[index]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transaction&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">people&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">people&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> pays &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">people&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">people&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> $&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">amt&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Include current transaction in the list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">min_trans_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">next_trans_list&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">transaction&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Backtrack the temporary change&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="n">debts&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">min_trans_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">min_txns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transactions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">min_txns&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">backtrack&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">transactions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">min_txns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Example usage:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">input_transactions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;payer&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;xia&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;amount&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;payees&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;xia&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;hao&amp;#39;&lt;/span>&lt;span class="p">]},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;payer&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;hao&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;amount&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">62&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;payees&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;xia&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;hao&amp;#39;&lt;/span>&lt;span class="p">]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">solution&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Solution&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">final_transactions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">solution&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">minTransfers&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_transactions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">final_transactions&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="code-demo-graph-approach">Code Demo Graph Approach&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">re&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">argparse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">typing&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Tuple&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">NodeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ne">Exception&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">EdgeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ne">Exception&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Edge&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">start_node&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end_node&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">start_node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">end_node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">weight&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">to_graphviz_string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> -&amp;gt; &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> [ label=&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#34; ];&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__str__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> -&amp;gt; &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">normalize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">print_edges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">graphviz&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">graphviz&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;digraph G {&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">normalize&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to_graphviz_string&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">graphviz&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">graphviz&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">add_weight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">node_name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight_delta&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">weights&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">node_name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">weight_delta&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">sort_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Tuple&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">]]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">sorted&lt;/span>&lt;span class="p">([(&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">()])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">get_node_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">weights&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">add_weight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">add_weight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">weights&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">find_greater_weight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weight_comp&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">weight&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">weight_comp&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">weights_to_edges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Tuple&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">]],&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Dict&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">current_node&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">current_weight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">current_node&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">current_weight&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">transact&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">current_weight&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">target&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">find_greater_weight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">transact&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">target&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">target&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">current_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">target&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">transact&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">weights&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">current_weight&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">edges&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">remove_zero_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Tuple&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">float&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">]]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">w&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">w&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">weights&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">w&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">split_star_nodes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">empty_nodes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">Edge&lt;/span>&lt;span class="p">]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nodes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">empty_nodes&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">+&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">verbose&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Found these &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> unique nodes: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_edges&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_edges&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extend&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">nodes&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">end_node&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_edges&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extend&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">Edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nodes&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">nodes&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">node&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">start_node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_edges&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">new_edges&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">SEARCH_COMMENT&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;^(#| *$)&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">SEARCH_EDGE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;(\w+|\*) *-&amp;gt; *(\w+|\*): *([0-9]+(\.[0-9]+)?)&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">SEARCH_NODE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">re&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">compile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;^(\w+)$&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">parse_edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="n">Edge&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">SEARCH_EDGE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">start_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">m&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">groups&lt;/span>&lt;span class="p">()[:&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">Edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">start_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">end_node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="n">EdgeException&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Invalid input line&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;__main__&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">argparser&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argparse&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ArgumentParser&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">argparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_argument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-g&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--graphviz&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">action&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;store_true&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">argparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_argument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;-v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--verbose&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">action&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;store_true&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">argparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add_argument&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;filename&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">nargs&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;?&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">args&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">argparser&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse_args&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">empty_nodes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">filename&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stdin&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">input_file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">enumerate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">input_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">parse_edge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="n">EdgeException&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">SEARCH_NODE&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">empty_nodes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">SEARCH_COMMENT&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Invalid input on line &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">line&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">stderr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split_star_nodes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">empty_nodes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">verbose&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">weights&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">get_node_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sorted_weights&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sort_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sorted_weights&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">remove_zero_weights&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Optionally perform a consistency check if verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">verbose&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="nb">round&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">_&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mf">0.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Node weights: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">edges&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">weights_to_edges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sorted_weights&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">verbose&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">edges&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">total_money_transacted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edge&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weight&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">edge&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">edges&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;Total money transacted: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">total_money_transacted&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">print_edges&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">edges&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">args&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">graphviz&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="github-link">Github Link&lt;/h2></description></item><item><title>System Design Interview Framework</title><link>https://blog.xiax.xyz/p/system-design-interview-framework/</link><pubDate>Sat, 23 Mar 2024 11:50:35 +0000</pubDate><guid>https://blog.xiax.xyz/p/system-design-interview-framework/</guid><description>&lt;img src="https://blog.xiax.xyz/p/system-design-interview-framework/banner.jpg" alt="Featured image of post System Design Interview Framework" />&lt;h1 id="system-design-interview-framework-from-alex-xu">System Design Interview Framework from Alex Xu&lt;/h1>
&lt;h2 id="step-1---understand-the-problem-and-establish-design-scope">&lt;strong>Step 1 - Understand the problem and establish design scope&lt;/strong>&lt;/h2>
&lt;p>In a system design interview, giving out an answer quickly without thinking gives you no bonus points. Answering without a thorough understanding of the requirements is a huge red flag as the interview is not a trivia contest. There is no right answer.&lt;/p>
&lt;p>&lt;strong>So, do not jump right in to give a solution.&lt;/strong> Slow down. Think deeply and ask questions to clarify requirements and assumptions. This is extremely important.&lt;/p>
&lt;p>As an engineer, we like to solve hard problems and jump into the final design; however, this approach is likely to lead you to design the wrong system. &lt;strong>One of the most important skills as an engineer is to ask the right questions, make the proper assumptions, and gather all the information needed to build a system. So, do not be afraid to ask questions.&lt;/strong>&lt;/p>
&lt;p>When you ask a question, the interviewer either answers your question directly or asks you to make your assumptions. If the latter happens, write down your assumptions on the whiteboard or paper. You might need them later.
What kind of questions to ask? Ask questions to understand the exact requirements. Here is a list of questions to help you get started:&lt;/p>
&lt;ul>
&lt;li>What specific features are we going to build? • How many users does the product have?&lt;/li>
&lt;li>How fast does the company anticipate to scale up? What are the anticipated scales in 3 months, 6 months, and a year?&lt;/li>
&lt;li>What is the company’s technology stack? What existing services you might leverage to simplify the design?&lt;/li>
&lt;/ul>
&lt;h2 id="step-2---propose-high-level-design-and-get-buy-in">&lt;strong>Step 2 - Propose high-level design and get buy-in&lt;/strong>&lt;/h2>
&lt;p>In this step, we aim to develop a high-level design and reach an agreement with the interviewer on the design. It is a great idea to collaborate with the interviewer during the process.&lt;/p>
&lt;ul>
&lt;li>Come up with an initial blueprint for the design. Ask for feedback. Treat your interviewer as a teammate and work together. Many good interviewers love to talk and get involved.&lt;/li>
&lt;li>Draw box diagrams with key components on the whiteboard or paper. This might include clients (mobile/web), APIs, web servers, data stores, cache, CDN, message queue, etc.&lt;/li>
&lt;li>Do back-of-the-envelope calculations to evaluate if your blueprint fits the scale constraints. Think out loud. Communicate with your interviewer if back-of-the-envelope is necessary before diving into it.&lt;/li>
&lt;/ul>
&lt;p>If possible, go through a few concrete use cases. This will help you frame the high-level design. It is also likely that the use cases would help you discover edge cases you have not yet considered.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Should we include API endpoints and database schema here?&lt;/p>
&lt;p>This depends on the problem. For large design problems like “Design Google search engine”, this is a bit of too low level. For a problem like designing the backend for a multi-player poker game, this is a fair game. Communicate with your interviewer.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="step-3-design-deep-dive">Step 3 Design Deep Dive&lt;/h2>
&lt;p>At this step, you and your interviewer should have already achieved the following objectives:&lt;/p>
&lt;ul>
&lt;li>Agreed on the overall goals and feature scope&lt;/li>
&lt;li>Sketched out a high-level blueprint for the overall design&lt;/li>
&lt;li>Obtained feedback from your interviewer on the high-level design&lt;/li>
&lt;li>Had some initial ideas about areas to focus on in deep dive based on her feedback&lt;/li>
&lt;/ul>
&lt;p>You shall work with the interviewer to identify and prioritize components in the architecture.
It is worth stressing that every interview is different.&lt;/p>
&lt;ul>
&lt;li>Sometimes, the interviewer may give off hints that she likes focusing on high-level design.&lt;/li>
&lt;li>Sometimes, for a senior candidate interview, the discussion could be on the system performance characteristics, likely focusing on the bottlenecks and resource estimations. In most cases, the interviewer may want you to dig into details of some system components.
&lt;ul>
&lt;li>For URL shortener, it is interesting to dive into the hash function design that converts a long URL to a short one.&lt;/li>
&lt;li>For a chat system, how to reduce latency and how to support online/offline status are two interesting topics.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>Time management is essential as it is easy to get carried away with minute details that do not
demonstrate your abilities. You must be armed with signals to show your interviewer. Try not to get into unnecessary details. For example, talking about the EdgeRank algorithm of Facebook feed ranking in detail is not ideal during a system design interview as this takes much precious time and does not prove your ability in designing a scalable system.&lt;/p>
&lt;h2 id="step-4-wrap-up">Step 4 Wrap up&lt;/h2>
&lt;p>In this final step, the interviewer might ask you a few follow-up questions or give you the freedom to discuss other additional points. Here are a few directions to follow:&lt;/p>
&lt;ul>
&lt;li>The interviewer might want you to identify the system bottlenecks and discuss potential improvements. Never say your design is perfect and nothing can be improved. There is always something to improve upon. This is a great opportunity to show your critical thinking and leave a good final impression.&lt;/li>
&lt;li>It could be useful to give the interviewer a recap of your design. This is particularly important if you suggested a few solutions. Refreshing your interviewer’s memory can be helpful after a long session.&lt;/li>
&lt;li>Error cases (server failure, network loss, etc.) are interesting to talk about.&lt;/li>
&lt;li>Operation issues are worth mentioning. How do you monitor metrics and error logs? How to roll out the system?&lt;/li>
&lt;li>How to handle the next scale curve is also an interesting topic. For example, if your current design supports 1 million users, what changes do you need to make to support 10 million users?&lt;/li>
&lt;li>Propose other refinements you need if you had more time.&lt;/li>
&lt;/ul>
&lt;p>To wrap up, we summarize a list of the Dos and Don’ts.&lt;/p>
&lt;p>&lt;strong>Dos&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Always ask for clarification. Do not assume your assumption is correct.&lt;/li>
&lt;li>Understand the requirements of the problem.&lt;/li>
&lt;li>There is neither the right answer nor the best answer. A solution designed to solve the
problems of a young startup is different from that of an established company with millions
of users. Make sure you understand the requirements.&lt;/li>
&lt;li>Let the interviewer know what you are thinking. Communicate with your interview.&lt;/li>
&lt;li>Suggest multiple approaches if possible.&lt;/li>
&lt;li>Once you agree with your interviewer on the blueprint, go into details on each
component. Design the most critical components first.&lt;/li>
&lt;li>Bounce ideas off the interviewer. A good interviewer works with you as a teammate.&lt;/li>
&lt;li>Never give up.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Don’ts&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Don&amp;rsquo;t be unprepared for typical interview questions.&lt;/li>
&lt;li>Don’t jump into a solution without clarifying the requirements and assumptions.&lt;/li>
&lt;li>Don’t go into too much detail on a single component in the beginning. Give the high-
level design first then drills down.&lt;/li>
&lt;li>If you get stuck, don&amp;rsquo;t hesitate to ask for hints.&lt;/li>
&lt;li>Again, communicate. Don&amp;rsquo;t think in silence.&lt;/li>
&lt;li>Don’t think your interview is done once you give the design. You are not done until your
interviewer says you are done. Ask for feedback early and often.&lt;/li>
&lt;/ul>
&lt;h2 id="time-allocation-on-each-step">&lt;strong>Time allocation on each step&lt;/strong>&lt;/h2>
&lt;p>System design interview questions are usually very broad, and 45 minutes or an hour is not
enough to cover the entire design. Time management is essential. How much time should you
spend on each step? The following is a very rough guide on distributing your time in a 45-
minute interview session. Please remember this is a rough estimate, and the actual time
distribution depends on the scope of the problem and the requirements from the interviewer.&lt;/p>
&lt;p>Step 1 Understand the problem and establish design scope: 3 - 10 minutes
Step 2 Propose high-level design and get buy-in: 10 - 15 minutes
Step 3 Design deep dive: 10 - 25 minutes
Step 4 Wrap: 3 - 5 minutes&lt;/p></description></item></channel></rss>